/*
 * This build file was auto generated by running the Gradle 'init' task
 * by 'NineKFlames' at '20.11.15 20:23' with Gradle 2.9
 *
 */

plugins {
  id "com.ullink.msbuild" version "2.11"
}

String deploymentDirPath = 'bin/deployment'
String leapDllsX64Dir = "$System.env.LEAP_SDK\\lib\\x64\\"
String configFilePath = '/MimeArm/App.config'

task updateProjectVersion {
    def stdout = new ByteArrayOutputStream()
    exec {
        commandLine 'git', 'describe'
        standardOutput = stdout
    }
    String version = stdout.toString().trim()
	String regex = '<add key="ProgramVersion" value=".+" />'
	File configFile = file(configFilePath)
	String configText = configFile.getText()
	configText = configText.replaceAll(regex, '<add key="ProgramVersion" value="' + version + '" />');
	configFile.write(configText)
}

task copyLeapDlls {
	copy {
		from file(leapDllsX64Dir + "Leap.dll")
		from file(leapDllsX64Dir + "LeapCSharp.dll")
		into file(deploymentDirPath)
	}
}

apply plugin:'msbuild'

msbuild {
	// get git tag as project version configuration
	updateProjectVersion
	solutionFile = 'MimeArm.sln'
	projectFile = file('MimeArm/MimeArm.csproj')
	
	// targets to execute (/t:Clean;Rebuild, no default)
	targets = ['Clean', 'Rebuild']
	
	// overrides project OutputPath
	destinationDir = deploymentDirPath
	
	// copy Leap Motion dll files needed for launch
	copyLeapDlls
}

assemblyInfoPatcher {
	version = project.version + '.0.0'
	
	// defaults to above version, fewer restrictions on the format
	fileVersion = version + '-Beta'
	
	// default to msbuild main project (of solution)
	projects = [ 'MimeArm' ]
}
